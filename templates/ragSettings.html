<html>
    <head>
        <!-- å¼•å…¥æœ¬åœ° Font Awesome å›¾æ ‡åº“ -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <!-- å¼•å…¥è‡ªå®šä¹‰æ ·å¼å• -->
        <link rel="stylesheet" href="{{ url_for('static', filename='documents.css') }}">
        <style>
        .progress-container {
            width: 300px;
            background: #eee;
            border-radius: 4px;
            margin: 20px 0;
        }
        #progress-bar {
            height: 24px;
            width: 0%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        #progress-text {
            text-align: center;
            padding: 5px;
            font-family: monospace;
        }
        #startbtn {
            cursor: pointer;
        }
        </style>
    </head>
<body>
    <script src="{{ url_for('static', filename='documents.js') }}"></script>
    <script src="{{ url_for('static', filename='knowledgelib.js') }}"></script>
    <script>

    </script>
    <div style="text-align: center;">
        <img src="{{ url_for('static', filename='step2.png') }}"></img>
    </div>
    <div class="knowledge-document-param-container" style="padding: 50px;margin-top: 20px;">
        <!-- åˆ†æ®µè®¾ç½® -->
        <div class="knowledge-document-config-section"">
            <div class="knowledge-document-section-title">ğŸ“ åˆ†æ®µè®¾ç½®</div>
            
            <div class="knowledge-document-param-group">
                <label>å—å¤§å° (chunk_size):</label>
                <div>
                    <input class="knowledge-document-input" type="number" id="chunkSize" min="128" max="2048" step="64" value="512">
                    <div class="knowledge-document-param-hint">
                        å•ä¸ªæ–‡æœ¬å—çš„æœ€å¤§é•¿åº¦ï¼Œè¾ƒçŸ­çš„å—é€‚åˆç²¾å‡†åŒ¹é…ï¼Œè¾ƒé•¿çš„å—ä¿ç•™æ›´å¤šä¸Šä¸‹æ–‡
                        <div class="knowledge-document-recommendation">æ¨èï¼šæ³•å¾‹æ¡æ¬¾256 | æŠ€æœ¯æ–‡æ¡£512 | ä¹¦ç±1024</div>
                    </div>
                </div>
            </div>

            <div class="knowledge-document-param-group">
                <label>é‡å é•¿åº¦ (overlap):</label>
                <div>
                    <input class="knowledge-document-input" type="number" id="overlap" min="0" max="512" step="32" value="128">
                    <div class="knowledge-document-param-hint">
                        ç›¸é‚»æ–‡æœ¬å—çš„é‡å é•¿åº¦ï¼Œç”¨äºä¿æŒä¸Šä¸‹æ–‡è¿è´¯æ€§
                        <div class="knowledge-document-recommendation">æ¨èï¼šchunk_sizeçš„20-25%ï¼ˆå¦‚512â†’128ï¼‰</div>
                    </div>
                </div>
            </div>

            <div class="knowledge-document-param-group">
                <label>é¢„å¤„ç†è§„åˆ™:</label>
                <div>
                    <label><input class="knowledge-document-input" type="checkbox" checked> å»é™¤ç‰¹æ®Šå­—ç¬¦</label>
                    <label><input class="knowledge-document-input" type="checkbox"> ä¿ç•™è¡¨æ ¼ç»“æ„</label>
                    <label><input class="knowledge-document-input" type="checkbox" checked> æ ‡å‡†åŒ–ç¼–å·æ ¼å¼</label>
                    <div class="knowledge-document-param-hint">
                        æ¸…ç†æ–‡æœ¬çš„é¢„å¤„ç†è§„åˆ™ï¼Œæ ¹æ®æ–‡æ¡£ç±»å‹é€‰æ‹©
                        <div class="knowledge-document-recommendation">æŠ€æœ¯æ–‡æ¡£ï¼šä¿ç•™è¡¨æ ¼ | åˆåŒæ–‡æœ¬ï¼šæ ‡å‡†åŒ–ç¼–å·</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç´¢å¼•æ–¹å¼ -->
        <div class="knowledge-document-config-section"">
            <div class="knowledge-document-section-title">ğŸ” ç´¢å¼•æ–¹å¼</div>
            
            <div class="knowledge-document-preset-template">
                <label>é¢„è®¾æ¨¡æ¿:</label>
                <select id="presetTemplate" onchange="updateTemplate(this.value)">
                    <option value="high_quality">é«˜è´¨é‡æ¨¡æ¿</option>
                    <option value="economic">ç»æµå‹æ¨¡æ¿</option>
                    <option value="custom">è‡ªå®šä¹‰</option>
                </select>
                <div class="knowledge-document-param-hint">
                    é¢„è®¾é…ç½®æ¨¡æ¿ï¼Œå¿«é€Ÿé€‚é…ä¸åŒåœºæ™¯éœ€æ±‚
                    <div class="knowledge-document-recommendation">é«˜è´¨é‡ï¼šç²¾ç¡®æ£€ç´¢ | ç»æµå‹ï¼šèµ„æºä¼˜åŒ–</div>
                </div>
                
                <div id="templateParams" style="margin-top:10px;">
                    <div class="knowledge-document-param-group">
                        <label>ç´¢å¼•ç²’åº¦:</label>
                        <select>
                            <option value="sentence">å¥å­çº§</option>
                            <option value="paragraph" selected>æ®µè½çº§</option>
                        </select>
                        <div class="knowledge-document-param-hint">
                            ç´¢å¼•çš„æœ€å°å•ä½ç²’åº¦
                            <div class="knowledge-document-recommendation">æ³•å¾‹æ–‡æœ¬ï¼šå¥å­çº§ | æŠ€æœ¯æ–‡æ¡£ï¼šæ®µè½çº§</div>
                        </div>
                    </div>
                    <div class="knowledge-document-param-group">
                        <label>ç´¢å¼•åˆ·æ–°é¢‘ç‡:</label>
                        <input class="knowledge-document-input" type="number" value="60" min="10" step="5"> åˆ†é’Ÿ
                        <div class="knowledge-document-param-hint">
                            ç´¢å¼•æ›´æ–°é¢‘ç‡ï¼ˆåˆ†é’Ÿï¼‰ï¼Œé«˜é¢‘æ›´æ–°ä¿è¯æ—¶æ•ˆæ€§
                            <div class="knowledge-document-recommendation">å®æ—¶ç³»ç»Ÿï¼š10-30åˆ†é’Ÿ | é™æ€æ–‡æ¡£ï¼š60+åˆ†é’Ÿ</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Embeddingæ¨¡å‹ -->
        <div class="knowledge-document-config-section"">
            <div class="knowledge-document-section-title">ğŸ§  Embeddingæ¨¡å‹</div>
            
            <div class="knowledge-document-param-group">
                <label>æ¨¡å‹é€‰æ‹©:<i class="fas fa-sync" style="cursor: pointer;" onclick="embedLoadModels()"></i></label>
                <select id="embeddingModel">
                    <option value="bge-large-zh">BGE-large-ä¸­æ–‡</option>
                    <option value="text2vec">Text2Vec-large</option>
                    <option value="custom">è‡ªå®šä¹‰æ¨¡å‹</option>
                </select>
                <div class="knowledge-document-param-hint">
                    é€‰æ‹©é€‚åˆæ–‡æ¡£è¯­è¨€çš„åµŒå…¥æ¨¡å‹
                    <div class="knowledge-document-recommendation">ä¸­æ–‡ä¼˜å…ˆBGE | å¤šè¯­è¨€é€‰Text2Vec</div>
                </div>
            </div>

            <div class="knowledge-document-param-group">
                <label>å‘é‡ç»´åº¦:</label>
                <div>
                    <input class="knowledge-document-input" type="number" value="768" disabled>
                    <div class="knowledge-document-param-hint">
                        åµŒå…¥å‘é‡çš„ç»´åº¦æ•°ï¼Œç»´åº¦è¶Šé«˜è¡¨å¾èƒ½åŠ›è¶Šå¼º
                        <div class="knowledge-document-recommendation">é€šç”¨åœºæ™¯768 | ä¸“ä¸šé¢†åŸŸ1024</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ£€ç´¢è®¾ç½® -->
        <div class="knowledge-document-config-section"">
            <div class="knowledge-document-section-title">âš¡ æ£€ç´¢è®¾ç½®</div>
            
            <div class="knowledge-document-param-group">
                <label>æ£€ç´¢ç­–ç•¥:</label>
                <select>
                    <option value="hybrid">æ··åˆæ£€ç´¢ï¼ˆå…³é”®è¯+å‘é‡ï¼‰</option>
                    <option value="vector">çº¯å‘é‡æ£€ç´¢</option>
                    <option value="keyword">å…³é”®è¯æ£€ç´¢</option>
                </select>
                <div class="knowledge-document-param-hint">
                    å¹³è¡¡å¬å›ç‡å’Œå‡†ç¡®æ€§çš„æ£€ç´¢ç­–ç•¥
                    <div class="knowledge-document-recommendation">å¸¸è§„ï¼šæ··åˆæ£€ç´¢ | ä¸“ä¸šæœ¯è¯­ï¼šå…³é”®è¯ä¼˜å…ˆ</div>
                </div>
            </div>

            <div class="knowledge-document-param-group">
                <label>è¿”å›ç»“æœæ•°:</label>
                <input class="knowledge-document-input" id="similarity_top_k" type="number" min="1" max="20" value="5">
                <div class="knowledge-document-param-hint">
                    å•æ¬¡æ£€ç´¢è¿”å›çš„æœ€å¤§ç»“æœæ•°é‡
                    <div class="knowledge-document-recommendation">ç²¾å‡†åœºæ™¯ï¼š3-5æ¡ | æ¢ç´¢æ€§æ£€ç´¢ï¼š10+æ¡</div>
                </div>
            </div>

            <div class="knowledge-document-param-group">
                <label>é‡æ’æ¨¡å‹:</label>
                <select>
                    <option value="bge-reranker">BGEé‡æ’æ¨¡å‹</option>
                    <option value="ce">Cross-Encoder</option>
                </select>
                <div class="knowledge-document-param-hint">
                    ç»“æœé‡æ’åºæ¨¡å‹ï¼Œæå‡æœ€ç»ˆç»“æœç›¸å…³æ€§
                    <div class="knowledge-document-recommendation">ä¸­æ–‡å†…å®¹ï¼šBGE | å¤æ‚æ¨ç†ï¼šCross-Encoder</div>
                </div>
            </div>
        </div>
        <button id="startBtn" style="width:100%;padding:12px;background:#3498db;color:white;border:none;border-radius:4px;" 
                onclick="processDocsBasedOnConfigs()">
            å¼€å§‹å¤„ç†
        </button>
        <div id="status"></div>
        <div style="margin-top: 15px;text-align: center;">
            <button id="knowledgeBasePrevPage"onclick="gotoUploadFilesPage()">ä¸Šä¸€æ­¥</button>&nbsp;&nbsp;&nbsp;&nbsp;
            <button id="knowledgeBaseNextPage" onclick="gotoResListPage()" style="right:20%">ä¸‹ä¸€æ­¥</button>
        </div>
    </div>
    
<script>
    const statusDiv = document.getElementById('status');
    async function processDocsBasedOnConfigs() {
        try{
            //console.log('knowledgeBaseDesc:',localStorage.getItem('knowledgeBaseDesc'));
            //console.log('knowledgeBaseName:',localStorage.getItem('knowledgeBaseName'));
            const btn = document.getElementById('startBtn');
            const nextPageBtn = document.getElementById('knowledgeBaseNextPage');
            nextPageBtn.disabled = true; // ç¦ç”¨ä¸‹ä¸€æ­¥æŒ‰é’®ï¼Œå¿…é¡»ç‚¹å‡»å¤„ç†ï¼Œå¤„ç†æˆåŠŸåå†å¯ç”¨


            const config = {
                "chunk_size": document.getElementById("chunkSize").value,
                "chunk_overlap": document.getElementById("overlap").value,
                "llm_model_name": localStorage.getItem('currentSelectedModel'),
                "embedding_model_name": document.getElementById("embeddingModel").value,
                "similarity_top_k": document.getElementById("similarity_top_k").value,
                "knowledge_base_name" : localStorage.getItem('knowledgeBaseName'),
                "process_mode":localStorage.getItem('processMode')
            }
            localStorage.setItem("documents_config", JSON.stringify(config));
            //console.log('knowledgeBaseName:',localStorage.getItem('knowledgeBaseName'));
            //console.log('documents_config:',JSON.stringify(config));
            if(knowledgeLibList !== null){
                knowledgeLibList.map(item => {
                    if (localStorage.getItem('knowledgeBaseName')) {
                        if(item.title === localStorage.getItem('knowledgeBaseName')){
                            return {
                                ...item,
                                ...config
                            };
                        }
                    }
                    return item;
                });
            }
            //console.log('knowledgeLibList:',knowledgeLibList);
            //console.log('knowledgeBaseName:',localStorage.getItem('knowledgeBaseName'));
            
            const maxIndex = knowledgeLibList.length;
            knowledgeLibList.push({ id: maxIndex + 1, title: localStorage.getItem('knowledgeBaseName'), description: "","description_1":  localStorage.getItem('knowledgeBaseDesc'),
                        config: {
                                "docs": JSON.stringify(config),
                                "database":{
                                },
                }
            });
            //console.log('knowledgeLibList:',knowledgeLibList);
            localStorage.removeItem("currentknowledgebase");
            localStorage.setItem("currentknowledgebase", JSON.stringify({ id: maxIndex + 1, title: localStorage.getItem('knowledgeBaseName'), description: "","description_1":  localStorage.getItem('knowledgeBaseDesc'),
                        config: {
                                "docs": JSON.stringify(config),
                                "database":{
                                },
                }
            }));
            statusDiv.innerHTML = '<i class="fas fa-sync fa-spin"></i>'
            const response = await fetch('http://127.0.0.1:5000/api/vrv-rag/docs', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(config),
            });
            if (!response.ok) {
                throw new Error(`HTTPé”™è¯¯! çŠ¶æ€ç : ${response.status}`);
            }
            const result = await response.json();
            statusDiv.innerHTML = ''
            statusDiv.innerHTML = result.message || 'å¤„ç†æ–‡ä»¶æˆåŠŸï¼ç‚¹å‡»ä¸‹ä¸€æ­¥æŸ¥çœ‹ç»“æœ';
            nextPageBtn.disabled = false; 

            let uploadStatus = JSON.parse(localStorage.getItem("uploadStatus"));
            const currentDatetime = new Date();
            if (uploadStatus && typeof uploadStatus === 'object') {
                // è·å–filesæ•°ç»„
                let filesArray = uploadStatus.files;
                documentData = []
                filesArray.map(function(file) {
                    documentData.push({
                        name: getFileName(file), 
                        mode: "é€šç”¨", 
                        charCount: 100, 
                        recallCount: 5, 
                        uploadTime: currentDatetime.toLocaleString(), 
                        status: "å®Œæˆ",
                        "category":"æ–‡æœ¬æ–‡æ¡£"
                    })
                })
            } else {
                console.error('æ— æ³•è·å–uploadStatusæˆ–å…¶ä¸æ˜¯æœ‰æ•ˆçš„å¯¹è±¡');
            }
            
        }catch(error){
            // ä¸Šä¼ å¤±è´¥å¤„ç†
            localStorage.setItem('uploadStatus', JSON.stringify({
                success: false,
                message: `ä¸Šä¼ å¤±è´¥: ${error.message}`
            }));
            // ä¿ç•™çª—å£æ˜¾ç¤ºé”™è¯¯
            statusDiv.className = 'error';
            statusDiv.textContent = `ä¸Šä¼ å¤±è´¥: ${error.message}`;
        }

    }
    function getFileName(filePath) {
        // ä½¿ç”¨ lastIndexOf æ‰¾åˆ°æœ€åä¸€ä¸ª '/' æˆ– '\' çš„ä½ç½®
        const lastSlashIndex = filePath.lastIndexOf('/');
        const lastBackslashIndex = filePath.lastIndexOf('\\');
        
        // å–è¾ƒå¤§çš„ç´¢å¼•å€¼
        const lastSeparatorIndex = Math.max(lastSlashIndex, lastBackslashIndex);
        
        // å¦‚æœæ²¡æœ‰æ‰¾åˆ°åˆ†éš”ç¬¦ï¼Œç›´æ¥è¿”å›æ•´ä¸ªå­—ç¬¦ä¸²
        if (lastSeparatorIndex === -1) {
            return filePath;
        }
        
        // æå–åˆ†éš”ç¬¦ä¹‹åçš„éƒ¨åˆ†
        return filePath.substring(lastSeparatorIndex + 1);
    }

    function updateProgressDisplay(data) {
        // ä¿æŒä¹‹å‰çš„è¿›åº¦æ›´æ–°é€»è¾‘
        document.getElementById('overall-bar').style.width = data.overall + '%';
        // ...å…¶ä»–æ˜¾ç¤ºæ›´æ–°
    }
    async function embedLoadModels(){
            const selectModel = document.getElementById('embeddingModel');
            try{
                selectModel.innerHTML = '<option sytle="font-size=8px;" value="">åŠ è½½ä¸­...</option>';

                const response = await fetch('http://localhost:11434/api/tags');
                
                if (!response.ok) {
                    console.log(response);
                throw new Error(`HTTP é”™è¯¯! çŠ¶æ€ç : ${response.status}`);
                }
                const data = await response.json();
                if(!data.models || data.models.length === 0){
                    selectModel.innerHTML = '<option sytle="font-size=8px;" value="">æ— å¯ç”¨æ¨¡å‹</option>';
                    return;
                }
                selectModel.innerHTML = data.models.map(model => 
                    `<option sytle="font-size=8px;" value="${model.name}">${model.name}</option>`)
                    .join('');
                if(data.length === 0){
                    selectModel.innerHTML = '<option value="">æ²¡æœ‰æ¨¡å‹ç”¨æˆ·</option>';
                }
            }catch(error){
                selectModel.innerHTML = '<option value="">è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥</option>';
                modelDescription.innerHTML = 
                '<p style="color:red;">è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥</p>';
                console.log('error:',error);
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            embedLoadModels();
        });

        function gotoResListPage() {

            // å‘çˆ¶çª—å£å‘é€æ¶ˆæ¯
            window.parent.postMessage({
                action: 'gotoRagSettings',
                url: "{{ url_for('knowledgeResList') }}"
            }, 'http://127.0.0.1:5000'); // æ›¿æ¢ä¸ºæ­£ç¡®çš„åŸŸå
            
        }
        function gotoUploadFilesPage() {
            // å‘çˆ¶çª—å£å‘é€æ¶ˆæ¯
            window.parent.postMessage({
                action: 'gotoUploadFilesPage',
                url: "{{ url_for('uploadFiles') }}"
            }, 'http://127.0.0.1:5000'); // æ›¿æ¢ä¸ºæ­£ç¡®çš„åŸŸå
            
        }
</script>
</body>
</html>